name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.railway_bot.txt
    
    - name: Test Railway integration imports
      run: |
        echo "üß™ Testing Railway integration imports..."
        python -c "from config_railway import RailwayConfig; print('‚úÖ RailwayConfig imported')"
        python -c "from railway_api_client import RailwayAPIClient; print('‚úÖ RailwayAPIClient imported')"
        python -c "from telegram_bot_railway import RailwayArticleBot; print('‚úÖ RailwayArticleBot imported')"
        echo "‚úÖ All Railway integration modules imported successfully!"
    
    - name: Test configuration
      run: |
        echo "üîß Testing Railway configuration..."
        python test_bot_config.py
    
    - name: Test basic functionality
      run: |
        echo "üöÄ Testing basic functionality..."
        python -c "import config; print('‚úÖ Config loaded successfully')"
        python -c "import telegram_bot; print('‚úÖ Telegram bot module imported')"
        python -c "import api_server; print('‚úÖ API server module imported')"
        echo "‚úÖ All basic modules working!"

  test-railway-api:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.railway_bot.txt
    
    - name: Test Railway API connection
      run: |
        echo "üåê Testing Railway API connection..."
        python test_railway_integration.py
      env:
        RAILWAY_API_URL: https://tg-article-bot-api-production-12d6.up.railway.app
        USE_RAILWAY_API: true

  deploy:
    needs: [test, test-railway-api]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Railway
      run: |
        echo "üöÄ Deploying to Railway..."
        echo "Railway will automatically deploy from this repository"
        echo "Check Railway dashboard for deployment status"
    
    - name: Deploy to Render
      run: |
        echo "üöÄ Deploying to Render..."
        echo "This would deploy the application to Render"
